---
title: "计算机网络体系结构概览"
date: 2021-03-24T21:38:51+08:00
Description: ""
Tags: [网络]
Categories: [计算机网络]
DisableComments: false
draft: true
---

## 名词说明

- 计算机网络的组成

计算机网络由若干结点(node)和连接这些结点的链路(link)组成，结点可以是计算机、集线器、交换机、路由器等。

路由器或网关可以把多个不同的网络连接起来，成为互连网，而互联网，则是全球范围内的互联网(也叫因特网，或Internet)。

- ISP

ISP是互联网服务提供商(比如我国的电信、移动、联通)。ISP可以从互联网管理机构获得许多IP地址，个人想要接入互联网需要向ISP缴纳一定的费用

- 主机之间的通信方式
  - 客户端-服务器(C/S)：客户端发送请求，服务端对请求进行响应
  - 对等(P2P)：不区分客户端和服务端
- OSI协议模型

![图片来自于网络，侵删](/images/net/OSI-protocol.png)

-  五层协议模型

1. 应用层：为特定应用程序提供数据传输服务，是规定了在两台主机的某两个**应用程序之间**，双方进行信息交换的协议，如浏览器使用的http、https、dns等。
2. 传输层：为**进程**之间提供数据传输服务，只负责在不同主机的两个进程之间提供数据传输，不涉及到数据传输的具体内容。传输层只有两个协议：TCP协议提供面向连接的可靠数据传输，UDP协议提供快速的及时性数据传输。
3. 网络层：为两台**跨局域网的主机**之间提供数据传输服务，所以路由器是属于网络层的。
4. 数据链路层：可以解决在一个**局域网内的主机**之间的数据传输服务
5. 物理层：如何在**硬件**上传输数据的比特流



- OSI另外规定的两层

1. 表示层：位于应用层下一层，数据的**展示**，压缩、加密以及数据描述。都是应用层内部的东西，完全可以取消，交给应用程序开发者处理。
2. 会话层：建立及管理会话，即**隔离**多个主机发到应用程序的数据。比如多个客户端请求服务端，每一个请求都应该隔离开，这个也是完全可以由应用程序开发者处理。



- TCP/IP协议使用的分层模型

如上图的第三个，实际上就是把五层的物理层和数据链路层合并成一个网络接口层。



实际上，并不一样要完全遵守分层的概念，应用层也可以直接使用IP层，或网络接口层的数据。毕竟，从数据链路层开始，就已经具备了通信的能力，如下：

![图片来自于网络，侵删](/images/net/not-layer.png)

- OSI七层模型整体概览

![图片来自于网络，侵删](/images/net/osi-7.jpg)

数据包在网络中的传输可以这样理解：在一台主机上的某个应用程序中产生的数据包，会在应用层所在的应用程序中使用某种应用层协议进行打包，然后经过表示、会话、传输、网络、数据链路层的层层打包封装后到达物理层，在物理层中通过某种介质手段，将封装好的数据包以0、1这样的二进制流，传递给另一台主机，而在另一台主机中，则是通过数据链路、网络、传输、会话、表示，经过层层拆包后到达位于应用层的应用程序，最后应用程序使用原本的应用层协议将数据包拆包以后，就得到了最原始的数据包了，那么两个主机上的两个应用程序之间的一次通信就完成了。

- 五层模型数据的流动

![7、](/images/net/7、.png)

## 五层协议介绍

### 物理层

物理层考虑的是，怎样才能在连接各种计算机的传输媒体上传输数据的比特流。物理层要尽可能的屏蔽掉不同的传输媒体(如电缆、光纤等)和通信手段的差异，使上层的数据链路层感觉不到数据传输的差异。

- 物理层的通信方式
  - 单工通信：永远只能一方向另一方单向传输，比如看电视，听收音机
  - 半双工通信：可以双向传输，但只能交替传输，你发一次我发一次，比如对讲机
  - 全双工通信：双向同时传输，比如打电话，或者面对面聊天
- 带通调制
  - 线缆中传输的都是离散的数字信号01，带通调制就是把数字信号转换为模拟信号数据链路层

物理层不是很重要，不多讲

### 数据链路层

数据链路层要解决的是在一个局域网内(比如星型拓扑结构的局域网)主机之间进行通信的问题。局域网虽然是个网络，但我们并不把局域网放在网络层中讨论。因为网络层要讨论的是在多个局域网互连的问题。

- 数据链路层使用的信道类型：
  - 点对点信道
  - 广播信道
- **封帧**

数据链路层会把网络层传下来的分组添加首部和尾部，标记帧的开始和结束。

![zhen](/images/net/zhen.png)

为什么会封装成帧呢？因为要同时传输多个目标主机的ip包，要保证同时传输过去，不能一个ip包一个ip包的传，防止一个ip包过大，阻塞了其他的ip包传不出去

- 透明传输

为保证帧头和帧尾的数据不会和数据报中的某些相同数据混淆，会在数据报中含有帧头和帧尾相同数据的部分加上转义字符，在另一头拆包之后再转义回来

- CRC校验

数据链路层广泛采用CRC循环冗余检验来保证传输过程中的数据不遗失，具体来说就是通过CRC算法对数据的总数进行加密，并把CRC校验和写入帧中，然后在另一头接收到了数据后同样计算一次CRC校验和，和从帧中拿到的校验和进行比较，如果一致，就说明数据没有遗失。

- 信道复用技术

1. 频分复用

所有主机在相同时间占用信道，但是发报频率不同，以此来复用信道

![pinfenfuyong](/images/net/pinfenfuyong.png)

2.  时分复用

所有主机在不同时间占用信道，发报频率相同，以此来复用信道

![shifenfuyong](/images/net/shifenfuyong.png)

3. 统计时分复用

不固定每个用户在时分复用帧中的相对位置，只要数据到了，并够了一帧就发包

![tongji](/images/net/tongji.png)

4. 波分复用

光波传输的频分复用，可以用更高的频率

5. 码分复用

不咋懂

- CSMA/CD协议

  - 多点接入：多个主机都连到总线上
  - 载波监听：每个主机都必须监听总线，如果监听到总线被占用则必须等待
  - 碰撞检测：如果在发送中监听到有其他主机正在发送数据，就表示发生了碰撞，由于电磁波的传播延时，还是有碰撞的可能的

  当发生了碰撞时，站点要停止发送，等待一段时间再发送，时间采用截断二进制指数退避算法来确定

- PPP协议

点对点协议。互联网用户一般都要连接到ISP(运营商)之后才能接入互联网，这个通信就是使用的PPP协议

- MAC地址

mac地址是链路层地址，用于唯一标识网卡，一台主机有多少个网卡就有多少个mac地址

- 以太网

以太网就是局域网，现在都以交换机进行连接（以前用集线器），交换机是链路层设备，能根据MAC地址进行存储转发

- 交换机

交换机中存储着mac地址到交换机上某个接口的映射，并且他是可以根据使用进行自学习的，不需要网络管理员手动配置交换表

- 三层的简化模型

![lianlu](/images/net/lianlu.png)

### 网络层

网络层是整个互联网的核心，IP协议可以把多个不同的局域网连接起来变成一个统一的网络。正如前面所说，网络层解决的是多个局域网的互连问题，让两台主机在不同的局域网中也能通信。

- 网络层除了IP协议之外还有三个配套使用的协议

  - 地址解析协议ARP

  网络层实现大量局域网中主机与主机之间的通讯，而链路层实现具体的每段链路之间的通信，所以在通信过程中，ip源和目的地址始终不变，而mac地址随着链路的改变而改变。

  ARP协议实现的就是由ip地址获得mac地址。

  每个主机上都有一个ARP告诉缓存，里面有本局域网上的各个主机和路由器的ip地址到mac地址的映射表，如果主机A要发送消息到主机B，但是高速缓存中没有B的ip地址到mac地址的映射，则主机A会广播，B收到广播就告知A自己的mac地址。

  - 网络控制报文协议ICMP

  ICMP的报文封装在ip数据报中，但是并不属于更高层的协议，仍是网络层的协议。主要应用就是ping，发送一个带有ICMP报文的ip包，用来测试两台主机的连通性，核心还是利用网络层让任意两台主机通信的能力。是一种测试用的协议。

  还有一个应用是traceroute，用来跟踪一个包从原点到终点的路径

  - 网际组管理协议IGMP

- IP地址的编址方式经历了三个阶段

1. 分类：ipV4的IP地址由两部分组成，网络号和主机号，一共32位，4个字节，根据网络号占总长度的多少，只有固定的A-E五类。

![A-E](/images/net/A-E.png)

​		主要用的是A、B、C三类地址，他们容纳的主机数量是逐渐缩小的。

2. 子网划分

通过在主机号中取一部分作为子网号，把两级的IP地址划为三级。这样可以把一个网络分出一个或多个子网出来。

3. 无分类、

无分类编址CIDR（CLasses Inter-Doman Routing）取消了ip地址的分类，只用随意定的网络号和主机号确定任意的网络大小。CIDR采用斜杠标记法，即在ip地址后加一个斜线，写上网络段所占的比特数（就对应子网掩码中比特1的个数），192.168.0.0/24，即前三个字节为网络位。

- 虚拟专用网络VPN

由于ipV4地址的紧缺，所以有的机构不需要把所有的主机都连入外部互联网，机构内的主机可以使用仅在本机构内部有效的IP地址。有三个专用的机构内网IP地址块：

1. 10.0.0.0 ~ 10.255.255.255
2. 172.16.0.0 ~ 172.31.255.255
3. 192.168.0.0 ~ 192.168.255.255

VPN会使用公用的互联网，但是机构内的主机只会与机构内其他主机通信。本质上只是通过路由器将全球地址和内网地址进行了转化，看起来好像是两个主机在一个内网似的

- 网络地址转换NAT

专用网内部的主机使用本地ip，但是想和互联网上的主机通信时，可以使用NAT将本地ip转换为全球IP，以前是将本地ip和全球ip进行一一对应，后来是把端口也用上了，使得本地ip映射到全球ip的某个端口号上，这叫做网络地址与端口转换NAPT

- 路由器

  - 路由器的功能：**路由选择、分组转发**。就像是快递站把相同目的地的邮件整理在一起统一发出去一样

  - 分组转发的流程：

    1. 从数据包中提取目的主机的ip地址D得到目的网络号N

    2. 若N就是此路由器直接相连的某个网络地址，则直接交付
    3. 若没有，则检查路由表中有目的地址为D的特定路由器，把数据包传给这个下一跳路由器
    4. 若没有，则检查路由表中有到达网络N的路由器，把数据传给这个下一跳路由器
    5. 若没有，则把数据传给路由表中默认的那个路由器（传递包的操作，都要通过ARP协议先根据ip获取到对应的mac，然后再传）
    6. 要是默认的也没有，就报错

  - 路由选择协议：路由选择协议都是自适应的

    - 内部网关协议RIP
    - 内部网关协议OSPF
    - 外部网关协议BGP

### 传输层

传输层解决的是某两个主机上的某两个端口之间通信的问题。传输层只有两个协议：UDP和TCP

#### UDP协议

用户数据报协议，他是一个无连接的，尽可能最大交付，没有拥塞控制，对上层报文只添加了UDP首部，速度快，支持一对多、一对一、多对一、多对多的通信。比如游戏应用一般都使用UDP

#### TCP协议

传输控制协议，他是一个面向连接的，提供可靠交付，有流量控制，拥塞控制，全双工通信，会拆分上层数据包，且只能是点对点的。TCP协议是使用最广泛的协议。

##### TCP数据包的格式

![TCP](/images/net/TCP.png)

- 序号：对上层数据字节流拆分成的TCP数据包进行编号，按字节数编号，比如序号为301，该段报文长100字节，那么下一段报文序号为401。
- 确认号：期望收到的下一段报文的序号，根据上次收到的报文序号和上一次的报文长度计算。
- 数据偏移：指实际数据距离该数据包起始处的偏移量，即这个tcp包首部的长度。
- 确认ACK：TCP规定建立连接后所有的报文的ACK都必须置为1。
- 同步SYN：建立连接时用来同步序号，当SYN=1，ACK=0时表示这是一个连接请求报文，开始三次握手，若对方同意连接，那么响应报文中SYN=1，ACK=1。
- 终止FIN：用来移除一个连接，FIN=1时，表示上层的所有数据都以通过TCP包发送完毕，申请释放连接，开始四次挥手。
- 窗口：窗口的值表示让对方设置每个发送包的最大大小，因为不同电脑的数据缓存空间是不同的，不能接收过大的数据包。

##### 三次握手

![3](/images/net/3.png)

- 过程
  - 服务端B处于LISTEN状态，等待客户连接
  - A向B发送连接请求的报文，SYN=1，ACK=0，选择一个初始的序号x，此时A进入SYN_SENT状态
  - B收到报文，如果同意连接，则向A发送报文，SYN=1，ACK=1，确认号为x+1（即希望下次接收到的包序号为x+1），同时也选择一个初始的序号y，B进入SYN_RCVD状态
  - 收到B的连接确认报文后，在发送B一个确认报文SYN=0，ACK=1，确认号为y+1（即希望下次收到的包序号为y+1），然后自己的序号是x+1
  - 然后两者都进入ESTABLISHED状态，连接建立成功
- 第三次握手的原因

为了防止失效的连接到达服务器，建立了错误的连接。应，那么在超时之后，就会重发一个请求，这样在两个请求都到达服务端后，服务端就会建立起两个连接。如果有第三次握手，客户端就可以确认自己已经建立了连接，并给后面服务端发来的响应第一次滞留请求的响应拒绝回复，即可保证二者只有一个连接。

##### 四次挥手

![4](/images/net/4.png)

- 过程
  - A、B都位于ESTABLISHED状态
  - A在没有数据想要发送时，发送报文请求断开连接，FIN=1，包序号为u，然后A进入FIN_WAIT_1状态
  - B收到报文后回复，ACK=1，ack=u+1，意为你上一个报文我收到了，然后给出自己的包序号v，同时B进入CLOSE_WAIT状态
  - A收到后进入FIN_WAIT_2状态
  - 在此时B仍然可以发送自己的数据包给A
  - B发完数据包后，会也发送一个申请断开连接的报文，FIN=1，ACK=1,ack=u+1（因为A没有再发报文过来，所以B期望收到A的报文序号仍为u+1），和自己这个包的序号w，然后B进入LAST_ACK状态
  - A收到B的断开请求后，返回ACK=1，意为也收到包序号w了，也填上自己的包序号u+1，和期望的包序号w+1，然后要进入一个TIME_WAIT状态
  - B收到A的确认之后，即可进入CLOSED状态
  - A在等待2MSL之后，没有收到B发过来的包，再进入CLOSED状态
- 四次挥手的原因

一方请求断开，但是不能立刻就断开，要等对方也想要断开所以才能断开，之所以四次挥手，不是两次或三次挥手，就是为了给时间让另一方把自己想发的包发完。

- TIME_WAIT的存在原因

防止A自己发的最后一个确认断开包，B没收到，如果B没收到就会重发包，这个时间一定再2MSL内，这是A还没有断开，所以依旧可以给回复。如果A不等2MSL直接断开，那么如果A的最后一条报文B没收到，B就会不停的重发，但是A已经断开了连接，B会处于无休止的工作之中。

#### 应用层

- 域名系统

DNS是一个分布式的数据库，提供了主机名和ip地址之间的转换服务，分布式是指：每个站点只保留它自己的那部分数据，域名有层次结构，从上到下分别为根域名、顶级域名（如com、net、edu）、二级域名（如google）。DNS服务器可以通过UDP也可以通过TCP进行传输。

- 文件传送协议

FTP使用TCP进行连接，通过两个连接来传送一个文件：

1. 控制连接：服务端通过端口21等待客户端连接，客户端建立连接后，使用这个连接双方传递命令
2. 数据连接：传送一个文件数据

- Web页面的请求过程
  1. DHCP配置主机信息、
     - 如果主机没有本地的ip地址等信息，则需要DHCP来获取
     - 主机生成一个DHCP报文，将其放入一个目的端口67，源端口68的UDP报文段中
     - 该UDP报文被放入一个具有广播IP地址255.255.255.255和源IP地址0.0.0.0的ip数据报中
     - 该数据报被放入mac帧中，然后将广播到所有与交换机连接的设备
     - 连接到了交换机的DHCP服务器，将报文分解得到DHCP请求报文，生成DHCP的ACK响应，包括ip地址、DNS地址、默认网关地址和子网掩码，然后通过交换机响应给请求主机
     - 主机得到该帧，就可以配置自己的ip地址、子网掩码、DNS地址、默认网关等数据
  2. ARP协议解析mac地址
     - DHCP拿到了网关路由器的IP地址，需要拿到网关路由器的mac地址，才能在链路层发出报文给网关路由器
     - 主机生成一个ARP查询报文，放入一个链路层的以太网帧中，并向交换机发送这个以太网帧，交换机会广播这个以太网帧
     - 局域网中的网关路由器拿到该帧后，就会得到原始的ARP报文，发现其中的ip地址与自己的ip地址匹配，就返回一个ARP包，包含它的mac地址给主机
  3. DNS解析域名
     - 主机根据域名生成一个DNS查询报文给网关路由器，路由器中配置了DNS服务器的路由选项，会根据路由表把数据包转发给DNS服务器
     - DNS会通过层层查找最终找到这个域名的ip地址，返回给主机
  4. 发送HTTP请求
     - 有了目的ip以后，主机就可以生成套接字，就可以发送http报文
     - 然后要三次连接，连接成功后就发送真正的请求
     - http服务器收到请求，返回响应
     - 浏览器拿到响应，渲染web页面

